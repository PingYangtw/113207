<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/static/images/favicon.ico" rel="shortcut icon"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/base/reset.css">
  <link rel="stylesheet" href="/static/css/base/global.css">
  <link rel="stylesheet" href="/static/css/components/mousemove.css">
  <link rel="stylesheet" href="/static/css/components/dialog.css">
	<link rel="stylesheet" href="/static/css/layout/navbar.css">
  <link rel="stylesheet" href="/static/css/layout/footer.css">
  <link rel="stylesheet" href="/static/css/community/communityMain.css">
  <link rel="stylesheet" href="/static/css/components/dialog.css">
  <link rel="stylesheet" href="https://unpkg.com/flickity@2/dist/flickity.min.css">
  <script src="https://kit.fontawesome.com/d9f27795c1.js" crossorigin="anonymous"></script>
  <script src="/static/components/mousemove.js" defer></script>
	<script src="/static/components/layout/navbar.js" defer></script>
  <script src="/static/components/layout/footer.js" defer></script>
  <script src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>
  <title>Q&A</title>
</head>
<body>
  <div id="myCursor"></div>
  <div id="circle"></div>

  <nav id="nav-container"></nav>

  <article>
    <div class="filter">
      <div class="select">
        <span>My</span>
        <div class="line"></div>
        <span>All</span>
      </div>
      <label class="keyword-query">
        <input type="text" id="keywordQuery" placeholder="關鍵字查詢">
        <i class="fa-solid fa-magnifying-glass"></i>
      </label>
    </div>

    <a class="po" href="/community/airecipePost">
      <div class="photostickers">
        <img src="/static/images/userImage/{{uid}}/{{userImage}}" alt="">
      </div>
      <div class="say">我有疑問...</div>
    </a>

    {% for question in question %}
    <form id="QnADetailForm" action="/community/detailedPost" method="get">
    <section>
      <div class="eachpo">
        <div class="photostickers">
          <img src="/static/images/userImage/{{question[1]}}/{{question[8]}}" alt="">
        </div>
        <div class="pocontent">
          <div class="top">
            <div class="left">
              <h1>{{ question[9] }}</h1>
              <span>{{ question[7].strftime('%Y/%m/%d %H:%M') }}</span>
            </div>
            <div class="right">
              {% if question[1] == uid %}
                <i class="fa-regular fa-trash-can" id="opendelete"></i>
                <a href="/community/airecipePost">
                  <i class="fa-regular fa-pen-to-square"></i>
                </a>
              {% else %}
                <i class="fa-regular fa-bookmark" id="opencollect"></i>
                <i class="fa-solid fa-triangle-exclamation" id="openreport"></i>
              {% endif %}
            </div>
          </div>
          <a class="middle">
            <h1>{{ question[2] }}</h1>
            <div class="textcontent">
              <p>{{ question[3] }}</p>
            </div>
            {% if question[4] %}
            <div class="carousel" data-flickity='{ "cellAlign": "left" }'>
              {% for image in question[14] %}
              <div class="carousel-cell">
                <img src="/static/images/community/{{question[1]}}/{{question[4]}}/{{image}}" alt="">
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </a>
          <div class="line"></div>
          {% if question[5] %}
          <div class="each">
            <div class="top">
              <div class="optimal">
                <i class="fa-solid fa-crown"></i>最佳解
              </div>
              <div class="right">
                <p>{{ question[11].strftime('%Y/%m/%d') }}</p>
                <div class="photostickers">
                  <img src="/static/images/userImage/{{question[12]}}/{{question[13]}}" alt="">
                </div>
              </div>
            </div>
            <div class="bottom">
              {{ question[10] }}
            </div>
          </div>
          {% endif %}
          {% if question[1] != uid and is_nutritionist == '2' %}
          <div class="bottom">
            <input type="text" placeholder="我來解說吧!">
            <button><i class="fa-regular fa-paper-plane"></i></button>
          </div>
          {% endif %}
        </div>

        <button type="submit" hidden>提交</button>
        <input type="hidden" name="question_id" value="{{ question[0] }}">
      </div>
    </section>
    </form>
    {% endfor %}
  </article>

  <a class="circlepo" href="/community/airecipePost">
    <i class="fa-solid fa-feather"></i>
  </a>

  <dialog id="delete">
    <h1>確定刪除貼文?</h1>
    <div class="contentsave">
      <button id="closedelete" class="closebtn">cancel</button>
      <button id="savedelete" class="savebtn">confirm</button>
    </div>
  </dialog>

  <dialog id="collect">
    <h1>編輯分類</h1>
    <div class="content">
      <div class="eachclass">
        <div class="left">
          <input type="checkbox" id="scales" name="scales" checked />
          <label for="scales">我的最愛</label>
        </div>
        <div class="num">(2篇)</div>
      </div>
      <div class="eachclass">
        <div class="left">
          <input type="checkbox" id="scales" name="scales" />
          <label for="scales">總有一天會用到</label>
        </div>
        <div class="num">(2篇)</div>
      </div>
      <div class="eachclass">
        <div class="left">
          <input type="checkbox" id="scales" name="scales" />
          <label for="scales">蔬食天堂</label>
        </div>
        <div class="num">(2篇)</div>
      </div>
      <div class="eachclass">
        <div class="left">
          <input type="checkbox" id="scales" name="scales" />
          <label for="scales">高蛋白飲食</label>
        </div>
        <div class="num">(2篇)</div>
      </div>
    </div>
    <div class="save">
      <button id="closecollect" class="closebtn closecollect">close</button>
      <button id="savecollect" class="savebtn savecollect">save</button>
    </div>
  </dialog>

  <dialog id="report">
    <h1>檢舉</h1>
    <div class="content">
      <h2>檢舉原因</h2>
      <div class="reasons">
        <div class="eachreason">
          <input type="checkbox" id="scales" name="scales" checked />
          <label for="scales">不實資訊</label>
        </div>
        <div class="eachreason">
          <input type="checkbox" id="scales" name="scales" />
          <label for="scales">違反公共秩序善良風俗</label>
        </div>
        <div class="eachreason">
          <input type="checkbox" id="scales" name="scales" />
          <label for="scales">違反法律</label>
        </div>
        <div class="eachreason">
          <input type="checkbox" id="scales" name="scales" />
          <label for="scales">違反法律</label>
        </div>
        <div class="eachreason">
          <input type="checkbox" id="scales" name="scales" />
          <label for="scales">賭博詐騙</label>
        </div>
        <div class="eachreason">
          <input type="checkbox" id="scales" name="scales" />
          <label for="scales">其他(請填在下方空格)</label>
        </div>
      </div>
      <textarea rows="5"></textarea>
    </div>
    <div class="save">
      <button id="closereport" class="closebtn">cancel</button>
      <button id="savereport" class="savebtn">confirm</button>
    </div>
  </dialog>

  <dialog id="loginDialog">
    <h1>請先登入</h1>
    <div class="contentsave">
      <button class="savebtn" onclick="window.location.href='/login/loginPage'">login</button>
    </div>
  </dialog>

  <footer id="footer-container"></footer>

  <script>
		let messageText = "{{name}}";
    let userImage = "{{userImage}}"
    let uid = "{{uid}}"

    window.onload = function() {
      renderNav();
      renderFooter();

      if (messageText == "0") {
        document.getElementById("loginDialog").showModal();
      }
    };

    function showModal() {
      document.getElementById("loginModal").style.display = "flex";
    }

    // detail頁面
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.pocontent').forEach(po => {
            po.addEventListener('click', function(event) {
                event.currentTarget.closest('form').submit();
            });
        });
    });


    // filter按鈕變化
    document.addEventListener("DOMContentLoaded", () => {
      const spans = document.querySelectorAll(".filter .select span");

      spans.forEach(span => {
        span.addEventListener("click", () => {
          spans.forEach(s => s.style.color = "#6E3D0D");
          span.style.color = "#FFCF56";
        });
      });
    });

    // 彈跳視窗
    function setupModal(openBtnId, modalId, closeBtnId, saveBtnId, onSaved) {
      const openBtn = document.getElementById(openBtnId);
      const modal = document.getElementById(modalId);
      const closeBtn = document.getElementById(closeBtnId);
      const saveBtn = document.getElementById(saveBtnId);

      openBtn.addEventListener("click", () => {
        if (openBtnId === 'opencollect') {
          if (openBtn.classList.contains('fa-regular')) {
            modal.showModal();
          } else {
            handleCollectSave();
          }
        } else {
          modal.showModal(); 
        }
      });

      closeBtn.addEventListener("click", () => modal.close());
      saveBtn.addEventListener("click", () => {
        onSaved();
        modal.close();
      });
    }

    const modals = [
      ['opendelete', 'delete', 'closedelete', 'savedelete', () => {}],
      ['openreport', 'report', 'closereport', 'savereport', () => {}],
      ['opencollect', 'collect', 'closecollect', 'savecollect', handleCollectSave],
    ];

    modals.forEach(modal => setupModal(...modal));

    // 改變收藏icon
    function handleCollectSave() {
      const openCollectButton = document.querySelector('.fa-regular.fa-bookmark, .fa-solid.fa-bookmark');
      if (openCollectButton) {
        if (openCollectButton.classList.contains('fa-regular')) {
          openCollectButton.classList.remove('fa-regular');
          openCollectButton.classList.add('fa-solid');
          openCollectButton.id = 'opencollect';
        } else {
          openCollectButton.classList.remove('fa-solid');
          openCollectButton.classList.add('fa-regular');
          openCollectButton.id = ''; 
        }
      }
    }

    // 發文小圓出場
    window.addEventListener('scroll', () => {
      const circlePo = document.querySelector('.circlepo');
      const triggerHeight = 200;
      if (window.scrollY > triggerHeight) {
        circlePo.classList.add('show');
      } else {
        circlePo.classList.remove('show');
      }
    });
	</script>
</body>
</html>